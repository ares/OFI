<%= render :layout => 'title' do %>
  <%= alert_if_deployed %>

  <div class="well">
    <div class="wizard-container">
      <%= deployment_wizard 4 %>
    </div>

    <div class="row">
      <!--<div class="title_filter col-md-6">-->
        <!--<%#= render "common/searchbar", :path => 'subnets_path' %>-->
      <!--<%#= yield(:search_bar) %>&nbsp;-->
      <!--</div>-->
      <div id="title_action" class="<%= "col-md-12" %>">
        <div class="btn-toolbar pull-right">
          <%= display_link_if_authorized(_("New Subnet"), hash_for_new_subnet_path(:redirect => request.url + '#new')) %>
        </div>
      </div>
    </div>

    <table class="table table-bordered table-striped table-two-pane" id="subnets_table">
      <tr>
        <th><%= sort :name, :as => s_("Subnet|Name") %></th>
        <th><%= sort :network, :as => s_("Subnet|Network") %></th>
        <th><%= _("Domains") %></th>
        <th><%= sort :vlanid, :as => s_('Subnet|Vlanid') %></th>
        <th><%= _("DHCP Proxy") %></th>
        <th></th>
      </tr>
      <tbody>
        <% for subnet in @subnets %>
          <tr data-subnet-id="<%= subnet.id %>">
            <td><%= link_to_if_authorized h(subnet.name), hash_for_edit_subnet_path(:id => subnet, :redirect => request.url + '#edit').merge(:auth_object => subnet, :authorizer => authorizer) %></td>
            <td><%= subnet.network_address %></td>
            <td><%= subnet.domains.to_sentence %></td>
            <td><%= subnet.vlanid %></td>
            <td><%= subnet.dhcp %></td>
            <td align="right">
              <%= display_delete_if_authorized hash_for_subnet_path(:id => subnet, :redirect => request.url).merge(:auth_object => subnet, :authorizer => authorizer), :confirm => _("Delete %s?") % subnet.name %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>

    <br />
    <%= form_for(@deployment, :url => wizard_path, :method => 'PUT', :html => {:class => ''}) do |f| %>
      <%= base_errors_for @deployment %>

      <% @deployment.layout.subnet_types.each do |subnet_type| %>
        <div class="well subnet_type" data-subnet-type-id="<%= subnet_type.id %>" id="<%= dom_id(subnet_type) %>">
          <h4><%= subnet_type.name %></h4>
          <ul>
            <%= render subnet_type.subnet_typings.where(:deployment_id => @deployment.id) %>
          </ul>
        </div>
      <% end %>

      <script>
        $(function() {
          $("#subnets_table tbody tr").draggable({
            appendTo: "body",
            helper: "clone"
          });
          $("div.subnet_type").droppable({
            activeClass: "ui-state-default",
            hoverClass: "ui-state-hover",
            accept: "#subnets_table tbody tr",
            drop: function(event, ui) {
              $.ajax({
                type: 'POST',
                url: '<%= url_for subnet_typings_path(:deployment_id => @deployment) %>',
                data: 'subnet_type_id=' + $(this).data('subnet-type-id') + '&subnet_id=' + ui.draggable.data('subnet-id'),
                dataType: 'script'
              });
            }
          });
        });
      </script>

      <div class="form_actions">
        <a class="btn btn-default" href="<%= previous_wizard_path %>">
          <span class="glyphicon glyphicon-chevron-left"></span>
          <%= _("Back") %>
        </a>
        <%= link_to _("Cancel"), deployment_path(@deployment),
                    :class => "btn btn-danger" %>
        <%= button_tag(:type => 'submit', :class => "btn btn-primary pull-right") do %>
          <%= _("Create OpenStack Deployment") %>
        <% end %>
      </div>
    <% end %>
  </div>
<% end %>
